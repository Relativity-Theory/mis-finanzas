<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanzas Minimal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #f2f2f7; /* Gris Apple */
            --card: #ffffff;
            --text-main: #1c1c1e;
            --text-sec: #8e8e93;
            --accent: #007aff;
            --danger: #ff3b30;
            --success: #34c759;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--bg); 
            color: var(--text-main); 
            margin: 0; padding: env(safe-area-inset-top) 20px 40px 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        /* Título y Balance */
        .header { width: 100%; max-width: 450px; margin: 30px 0; }
        .label-top { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-sec); margin-bottom: 5px; }
        .balance-main { font-size: 2.8rem; font-weight: 800; letter-spacing: -1px; }

        /* Cuadro Gastos del Mes - Estilo High-End */
        .gastos-card {
            width: 100%; max-width: 450px;
            background: var(--text-main);
            color: white;
            border-radius: 20px;
            padding: 25px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            margin-bottom: 25px;
            box-sizing: border-box;
        }
        .gastos-card span:first-child { font-size: 0.9rem; font-weight: 500; opacity: 0.8; }
        .gastos-card span:last-child { font-size: 1.6rem; font-weight: 700; }

        /* Ahorro Secundario */
        .savings-row {
            width: 100%; max-width: 450px;
            background: var(--card);
            padding: 18px 25px;
            border-radius: 18px;
            display: flex; justify-content: space-between;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            box-sizing: border-box;
        }

        /* Botones */
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 450px; }
        button { 
            border: none; padding: 18px; border-radius: 16px; font-weight: 600; font-size: 0.95rem;
            transition: transform 0.1s ease, opacity 0.2s; cursor: pointer;
        }
        button:active { transform: scale(0.97); opacity: 0.8; }
        
        .btn-in { background: #e8f5e9; color: var(--success); }
        .btn-out { background: #ffebee; color: var(--danger); }
        .btn-save { background: #e3f2fd; color: var(--accent); grid-column: span 2; margin-top: 5px; }

        /* Tabla Estilo Minimal */
        .history-section { width: 100%; max-width: 450px; margin-top: 35px; }
        .history-section h3 { font-size: 1.1rem; margin-bottom: 15px; padding-left: 5px; }
        
        .table-wrapper { background: var(--card); border-radius: 20px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 15px; color: var(--text-sec); font-weight: 500; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 15px; border-top: 1px solid var(--bg); }
        .td-monto { font-weight: 600; }

        /* Botón Excel */
        .btn-excel {
            width: 100%; max-width: 450px; background: var(--accent); color: white;
            margin-top: 30px; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="label-top">Disponible</div>
    <div class="balance-main" id="disp-total">$0</div>
</div>

<div class="gastos-card">
    <span>GASTOS DEL MES</span>
    <span id="disp-gastos-mes">$0</span>
</div>

<div class="savings-row">
    <span style="color: var(--text-sec); font-weight: 500;">Ahorro Acumulado</span>
    <span style="font-weight: 700;" id="disp-ahorro">$0</span>
</div>

<div class="actions-grid">
    <button class="btn-in" onclick="registrar('ingreso')">Ingreso (+)</button>
    <button class="btn-out" onclick="registrar('gasto')">Gasto (-)</button>
    <button class="btn-save" onclick="registrar('ahorro')">Mover a Ahorro</button>
</div>

<div class="history-section">
    <h3>Movimientos Recientes</h3>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Motivo</th>
                    <th>Monto</th>
                </tr>
            </thead>
            <tbody id="lista-movs"></tbody>
        </table>
    </div>
</div>

<button class="btn-excel" onclick="descargarExcel()">
    Descargar Reporte Excel
</button>

<script>
    let db = JSON.parse(localStorage.getItem('finanzas_v3')) || { total: 0, ahorro: 0, movs: [] };

    const fmt = (n) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(n);

    function actualizar() {
        document.getElementById('disp-total').innerText = fmt(db.total);
        document.getElementById('disp-ahorro').innerText = fmt(db.ahorro);
        
        const hoy = new Date();
        const totalMes = db.movs
            .filter(m => m.tipo === 'GASTO' && new Date(m.fechaFull).getMonth() === hoy.getMonth() && new Date(m.fechaFull).getFullYear() === hoy.getFullYear())
            .reduce((acc, curr) => acc + curr.monto, 0);
        
        document.getElementById('disp-gastos-mes').innerText = fmt(totalMes);

        const tbody = document.getElementById('lista-movs');
        tbody.innerHTML = '';
        db.movs.slice(-5).reverse().forEach(m => {
            const colorMonto = m.tipo === 'INGRESO' ? 'var(--success)' : (m.tipo === 'GASTO' ? 'var(--danger)' : 'var(--accent)');
            tbody.innerHTML += `
                <tr>
                    <td style="color: var(--text-sec)">${m.fechaShort}</td>
                    <td style="font-weight: 500">${m.motivo}</td>
                    <td class="td-monto" style="color: ${colorMonto}">${m.tipo === 'GASTO' ? '-' : '+'}${fmt(m.monto)}</td>
                </tr>`;
        });
        localStorage.setItem('finanzas_v3', JSON.stringify(db));
    }

    function registrar(tipo) {
        const motivo = prompt(`¿Motivo del ${tipo}?`);
        if (!motivo) return;
        const monto = parseInt(prompt(`Monto en CLP:`));
        if (isNaN(monto) || monto <= 0) return;

        if (tipo === 'ingreso') db.total += monto;
        else if (tipo === 'gasto') db.total -= monto;
        else if (tipo === 'ahorro') {
            if (monto > db.total) return alert("Saldo insuficiente");
            db.total -= monto; db.ahorro += monto;
        }

        db.movs.push({
            fechaFull: new Date().toISOString(),
            fechaShort: new Date().toLocaleDateString('es-CL', {day:'2-digit', month:'short'}),
            tipo: tipo.toUpperCase(),
            motivo: motivo,
            monto: monto,
            saldoSnapshot: db.total
        });
        actualizar();
    }

    function descargarExcel() {
        if (db.movs.length === 0) return alert("Sin datos");
        const data = db.movs.map(m => ({
            'FECHA': new Date(m.fechaFull).toLocaleString('es-CL'),
            'CATEGORÍA': m.tipo,
            'DESCRIPCIÓN': m.motivo,
            'MONTO (CLP)': m.monto,
            'SALDO FINAL': m.saldoSnapshot
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reporte");
        XLSX.writeFile(wb, "Mis_Finanzas.xlsx");
    }

    actualizar();
</script>
</body>
</html>